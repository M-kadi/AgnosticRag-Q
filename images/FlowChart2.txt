flowchart TD
  A[User Query] --> B{enable_auto_translate?}
  B -- Yes --> C[Translate to English using translate_prompt_template]
  B -- No --> D[Use Original Query]
  C --> E[English/Final Query]
  D --> E[English/Final Query]

  E --> F["Embed Query (Embedding Provider)"]
  F --> G[Retrieve TopK from Qdrant]

  G --> H{enable_rerank?}
  H -- Yes --> I[Rerank with LLM prompt; select top_k_use]
  H -- No --> J[Select first top_k_use]
  I --> K[Final Context]
  J --> K[Final Context]

  K --> L{needs_history AND history_turns>0?}
  L -- Yes --> M["Load History from Redis (app/user/session)"]
  L -- No --> N[History = empty]
  M --> O[Build Prompt: History + Context + Query]
  N --> O[Build Prompt: Context + Query]

  O --> P[Chat LLM]
  P --> Q[Return Answer]

  Q --> R{Redis enabled?}
  R -- Yes --> S["Append to Redis: question + answer (+ time)"]
  R -- No --> T[Done]
