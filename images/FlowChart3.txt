flowchart TD
  A[User Query] --> B{enable_auto_translate?}
  B -- Yes --> C["Translate to English (translate_prompt_template)"]
  B -- No --> D[Use Original Query]
  C --> E[Final Query]
  D --> E[Final Query]

  E --> F["Embed Query (Embedding Provider)"]

  %% Parallel retrieval
  F --> G[Qdrant: Retrieve TopK doc chunks]
  F --> H[PostgreSQL Memory: find similar past queries/answers/evidence]
  
  G --> I{enable_rerank?}
  I -- Yes --> J[Rerank doc chunks with LLM; select top_k_use]
  I -- No --> K[Select first top_k_use]
  J --> L[Doc Context]
  K --> L[Doc Context]

  H --> M["Memory Context (past Q/A + sources)"]

  L --> N[Merge/Trim Context: Memory + Docs]
  M --> N

  N --> O{needs_history AND history_turns>0?}
  O -- Yes --> P[Load Session History from Redis]
  O -- No --> Q[History = empty]

  P --> R[Build Prompt: Redis History + Merged Context + Query]
  Q --> R[Build Prompt: Merged Context + Query]

  R --> S[Chat LLM]
  S --> T[Return Answer]

  %% Write-back
  T --> U[Write-back to PostgreSQL Memory: query + answer + retrieved evidence + scores + timestamps]
  T --> V{Redis enabled?}
  V -- Yes --> W["Append to Redis: question + answer (+ time)"]
  V -- No --> X[Done]
